----CHAPTER-04
----WINDOWS FUNCTION
----AGGREGATED WINDOWS FUNCTION

--SET NOCOUNT ON;
--USE tempdb;

--ORDERVALUE TABLE
IF OBJECT_ID(N'DBO.ORDERVALUES', N'U') IS NOT NULL DROP TABLE DBO.ORDERVALUES;

SELECT * INTO DBO.ORDERVALUES FROM TSQLV3.Sales.OrderValues

ALTER TABLE DBO.ORDERVALUES ADD CONSTRAINT PK_ORDERVALUES PRIMARY KEY (ORDERID);

GO

--EMPORDERS TABLE

IF OBJECT_ID(N'DBO.EMPORDERS', N'U') IS NOT NULL DROP TABLE DBO.EMPORDERS;

SELECT empid, ISNULL(ordermonth, CAST('19000101' AS DATE)) AS ordermonth, qty,
val, numorders
INTO DBO.EMPORDERS
FROM TSQLV3.Sales.EmpOrders;

ALTER TABLE DBO.EMPORDERS ADD CONSTRAINT PK_EMPORDERS PRIMARY KEY(EMPID, ORDERMONTH);
GO

--TRANSATIONS TABLE 

-- Transactions table
IF OBJECT_ID('dbo.Transactions', 'U') IS NOT NULL DROP TABLE dbo.Transactions;
IF OBJECT_ID('dbo.Accounts', 'U') IS NOT NULL DROP TABLE dbo.Accounts;

CREATE TABLE dbo.Accounts
(
actid INT NOT NULL CONSTRAINT PK_Accounts PRIMARY KEY
);

CREATE TABLE dbo.Transactions
(
actid INT NOT NULL,
tranid INT NOT NULL,
val MONEY NOT NULL,
CONSTRAINT PK_Transactions PRIMARY KEY(actid, tranid)
);

DECLARE 
@NUM_PARTITIONS AS INT = 100, 
@ROWS_PER_PARTITION AS INT = 2000;


INSERT INTO DBO.ACCOUNTS WITH (TABLOCK) (ACTID) 
SELECT NP.N
FROM TSQLV3.DBO.GETNUMS(1, @NUM_PARTITIONS) AS NP;

INSERT INTO DBO.TRANSACTIONS WITH (TABLOCK)  (ACTID, TRANID, VAL)
SELECT NP.N, RPP.N, 
(ABS(CHECKSUM(NEWID())%2)*2-1) * (1+ abs(CHECKSUM(NEWID())%5))
FROM TSQLV3.DBO.GetNums(1, @NUM_PARTITIONS) AS np
CROSS JOIN TSQLV3.DBO.GetNums(1, @ROWS_PER_PARTITION) AS RPP;


 --LIMITATION PG344 working on queries at work
 --WINDOWS ELEMENT 


--SELECT EMPID, ORDERMONTH, QTY, 
--SUM(QTY) over (partition BY EMPID ORDER BY ORDERMONTH ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) AS RUNQTY
--FROM DBO.EMPORDERS;

-- PG 348 WINDOWS PARITION 

--SELECT orderid, custid, val, 

--CAST(100. *  VAL / SUM(VAL) OVER() AS NUMERIC (5,2)) AS PCTALL, 
--CAST(100. *  VAL / SUM(VAL) OVER (PARTITION BY CUSTID)  AS NUMERIC (5,2)) AS PCTCUST
--FROM DBO.ORDERVALUES
--ORDER BY CUSTID


SELECT ACTID, TRANID, VAL, 
VAL / SUM(VAL) over() AS PCTALL, 
VAL / SUM(VAL) OVER(PARTITION BY ACTID) AS  PCTAT
FROM DBO.Transactions

WITH GRANDAGG AS 
(
SELECT SUM(VAL) AS SUMALL FROM DBO.Transactions
), 

ACTAGG AS 
(
SELECT ACTID, SUM(VAL) AS SUMACT FROM 
DBO.Transactions
GROUP BY actid
)

SELECT T.actid, T.tranid, T.val, 
T.VAL/GA.SUMALL AS PCTALL,
T.VAL/AA.SUMACT AS PCTALL
FROM DBO.Transactions AS T
CROSS JOIN GRANDAGG AS GA
INNER JOIN ACTAGG AS AA
ON AA.ACTID = T.actid


SELECT CUSTID, SUM(VAL) AS CUSTOTAL
FROM DBO.ORDERVALUES
GROUP BY custid

SELECT CUSTID, SUM(VAL) AS CUSTOTAL,
SUM(VAL)/SUM(SUM(VAL)) over() AS PCT
FROM DBO.ORDERVALUES
GROUP BY custid

-356


SELECT empid, ordermonth, QTY,
SUM(QTY) OVER (PARTITION BY EMPID ORDER BY ORDERMONTH ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RUNQTY

FROM DBO.EMPORDERS




SELECT custid, ORDERID, VAL, ORDERDATE, 

SUM(VAL) OVER (PARTITION BY  CUSTID, YEAR(ORDERDATE) ORDER BY ORDERDATE RANGE UNBOUNDED PRECEDING) AS YTD_VAL
FROM DBO.ORDERVALUES

SET NOCOUNT ON;
USE tempdb;
IF OBJECT_ID(N'dbo.Orders', N'U') IS NOT NULL DROP TABLE dbo.Orders;
CREATE TABLE dbo.Orders
(
orderid INT NOT NULL,
orderdate DATE NOT NULL,
empid INT NOT NULL,
custid VARCHAR(5) NOT NULL,
qty INT NOT NULL,
CONSTRAINT PK_Orders PRIMARY KEY (orderid)
);
GO
INSERT INTO dbo.Orders(orderid, orderdate, empid, custid, qty)
VALUES(30001, '20130802', 3, 'B', 10),
(10001, '20131224', 1, 'C', 10),
(10005, '20131224', 1, 'A', 30),
(40001, '20140109', 4, 'A', 40),
(10006, '20140118', 1, 'C', 10),
(20001, '20140212', 2, 'B', 20),
(40005, '20140212', 4, 'A', 10),
(20002, '20140216', 2, 'C', 20),
(30003, '20140418', 3, 'B', 15),
(30004, '20140418', 3, 'B', 20),
(30007, '20140907', 3, 'C', 30);


SELECT ORDERID, QTY, 
ROW_NUMBER() Over( ORDER BY QTY, ORDERID) AS ROWNUM, 
RANK() Over( ORDER BY QTY) AS RANK,
DENSE_RANK() over(ORDER BY QTY) AS DENSERANK,
NTILE(4) OVER (ORDER BY QTY) AS NTILE
FROM DBO.Orders





SELECT CUSTID, ORDERID, QTY, 
ROW_NUMBER() Over( PARTITION BY CUSTID ORDER BY ORDERID) AS ROWNUM
FROM DBO.Orders


-- OFFSET WINDOWS FUNCTION PG 374

